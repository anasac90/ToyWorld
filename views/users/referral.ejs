<%- include('../partials/user-header.ejs') %>

    <main class="mt-5" style="height: auto;">
        <div class="content-head">
            <div class="content-head-rect col-5 bg-dark-grn">
                <div>
                    <h2 class="content-head-txt">REFERRAL</h2>
                </div>
                <div class="content-head-tri ms-auto"></div>
            </div>
        </div>

        <div class="content-body side-margin mt-3">
            <div class="profile-content" style="width:100%;">
                <div class="content-main mt-3">
                    <div style="width:100%; max-width:1100px; margin:0 auto;">


                        <div class="card"
                            style="padding:1rem; background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.05);">


                            <div
                                style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                                <div style="display:flex; align-items:center; gap:12px; width: 100%;">
                                    <div style="font-weight:700; color:#66A5AD;">Your Referral Code</div>
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <span id="myReferralCode" style="font-size:1.15rem; font-weight:600;">
                                            <%= user?.[0]?.referralCode || '' %>
                                        </span>
                                        <button id="copyReferralBtn" class="btn btn-sm"
                                            style="background:#66A5AD; color:#fff; border:none; padding:6px 10px;">Copy</button>
                                    </div>
                                </div>

                                <div style="font-size:0.95rem; color:#333;">
                                    <% now=new Date(); %>
                                        <% if(referralOffer && referralOffer[0]?.expiryDate> now) { %>
                                            <p class="text-secondary" style="font-weight: 100;">
                                                Share this code with friends and get Rs.<%=
                                                    referralOffer[0]?.referralAmount %> for you and your friend into
                                                    the wallet.
                                            </p>
                                            <% } %>
                                </div>
                            </div>

                            <hr style="margin:1rem 0; border: none; border-top:1px solid #eee;" />


                            <% if (referralByDetails) { %>
                                <div id="referred-summary"
                                    style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                                    <div style="display:flex; gap:12px; align-items:center;">
                                        <div style="font-weight:700; color:#666;">Referred By</div>
                                        <div style="padding:8px 12px; background:#f1f7f7; border-radius:6px;">
                                            <div style="font-weight:600;">
                                                <%= referralByDetails.referralByFName %>
                                                    <%= referralByDetails.referralByLName %>
                                            </div>
                                            <div style="font-size:0.9rem; color:#444;">
                                                <%= referralByDetails.referralByCode %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <% } else { %>

                                    
                                    <div id="apply-area">
                                        <form action="/applyReferral" method="post"
                                            style="display: flex; gap:10px; align-items:center; flex-wrap:wrap;">
                                            <label for="referredByCode"
                                                style="min-width:140px; font-weight:600; color:#444;">Who referred
                                                you?</label>
                                            <input id="referredByCode" name="referredByCode" type="text"
                                                class="form-control" placeholder="Enter their referral code"
                                                style="max-width:300px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                            <button id="applyReferralBtn" class="btn bg-dark-grn" type="submit"
                                                style="color:white;">Apply</button>
                                        </form>

                                        <div id="referralMsg" style="min-width:220px; color:#666; font-size:0.95rem;">
                                        </div>
                                    </div>

                                    <div id="referralOffer">
                                        <% now=new Date(); %>
                                            <% if(referralOffer && referralOffer[0]?.expiryDate> now) { %>
                                                <p class="text-secondary" style="font-weight: 100;">
                                                    Enter the referral code and get Rs.<%=
                                                        referralOffer[0]?.referralAmount %> for you and your friend into
                                                        the wallet.
                                                </p>
                                                <% } %>
                                    </div>

                                    <div style="margin-top:10px; color:#666; font-size:0.9rem;">
                                        Tip: Get the referral code from the friend who invited you. Applying a code is
                                        one-time and cannot be changed later.
                                    </div>

                                    <% } %>

                        </div>
                        <!-- /Card -->

                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Safe element getters
            const copyBtn = document.getElementById('copyReferralBtn');
            const myCodeEl = document.getElementById('myReferralCode');
            const applyBtn = document.getElementById('applyReferralBtn');
            const input = document.getElementById('referredByCode');
            const msgEl = document.getElementById('referralMsg');

            if ("<%= message %>") {
                if ("<%= message.success %>" === "true") {
                    toastr.info("<%= message.status %>");
                } else {
                    toastr.warning("<%= message.status %>")
                }
            }


            // Copy referral code
            if (copyBtn && myCodeEl) {
                copyBtn.addEventListener('click', async () => {
                    const code = (myCodeEl.innerText || '').trim();
                    if (!code) return;
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(code);
                        } else {
                            // fallback
                            const ta = document.createElement('textarea');
                            ta.value = code;
                            document.body.appendChild(ta);
                            ta.select();
                            document.execCommand('copy');
                            ta.remove();
                        }
                        copyBtn.textContent = 'Copied';
                        setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                    } catch (err) {
                        console.error('Copy failed', err);
                        alert('Copy failed. Please copy manually: ' + code);
                    }
                });
            }
        })


    </script>

    <%- include('../partials/user-footer.ejs') %>