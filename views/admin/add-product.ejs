<%- include ('../partials/admin-header.ejs') %>


    <main class="mt-3" style="height: auto;">
        <div class=" content-head">
            <div class="content-head-rect col-5 bg-dark-grn">
                <div>
                    <h2 class="content-head-txt">ADD PRODUCT</h2>
                </div>
                <div class="content-head-tri ms-auto"></div>
            </div>
        </div>
        <div class="content-body side-margin text-start mt-3" style="justify-content: center;">
            <form autocomplete="off" action="/admin/products/submit" enctype="multipart/form-data" method="POST"
                class="col-4">
                <% if(status) { %>
                    <p style="text-align: center; color: green; font-weight:700;">
                        <%= status %>
                    </p>
                    <% } %>
                        <% if(warning) { %>
                            <p style="text-align: center; color: red; font-weight:700;">
                                <%= warning %>
                            </p>
                            <% } %>
                                <% if(!productData) { %>
                                    <div class="col mb-3">
                                        <label>Product Name: <span style="color:red">*</span></label>
                                        <input class="form-control" placeholder="Enter the product name"
                                            name="productName" type="text">
                                    </div>
                                    <div class="col mb-3">
                                        <label>Price: <span style="color:red">*</span></label>
                                        <input class="form-control" placeholder="Price of the product" name="price"
                                            type="number">
                                    </div>
                                    <div class="col mb-3">
                                        <label>Stock Quantity: <span style="color:red">*</span></label>
                                        <input class="form-control" placeholder="Stock quantity" name="stockQuantity"
                                            type="number">
                                    </div>
                                    <div class="col mb-3">
                                        <label>Product Code: <span style="color:red">*</span></label>
                                        <input class="form-control" placeholder="Product code" name="productCode"
                                            type="text">
                                    </div>
                                    <div class="mb-3">
                                        <label>Minimum Age: <span style="color:red">*</span></label>
                                        <input class="form-control" type="number" name="minimumAge"
                                            placeholder="Minimum age" />
                                    </div>
                                    <div class="mb-3">
                                        <label>Category: <span style="color:red">*</span></label>
                                        <div class="input-group mb-3">
                                            <select class="form-select" id="category" name="category">
                                                <option selected>Choose...</option>
                                                <% for(let j=0; j < categories.length;j++) { %>
                                                    <option value="<%=categories[j] %>">
                                                        <%= categories[j] %>
                                                    </option>
                                                    <% } %>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Brand: <span style="color:red">*</span></label>
                                        <div class="input-group mb-3">
                                            <select class="form-select" id="brand" name="brand">
                                                <option selected>Choose...</option>
                                                <% for(let k=0; k < brands.length; k++) { %>
                                                    <option value=<%=brands[k] %>><%= brands[k] %>
                                                    </option>
                                                    <% } %>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col mb-3">
                                        <label>Description: <span style="color:red">*</span></label>
                                        <textarea class="form-control" placeholder="Enter the description"
                                            name="productDescription" type="text"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label>Images: <span style="color:red">*</span></label>
                                        <div class="mb-2" id="img-preview"></div>
                                        <input class="form-control mb-1" type="file" accept="image/*"
                                            name="productImages" id="imageInput" multiple required />
                                        <div style="display: flex;">
                                            <div id="crop-container" style="width: 50%; height: 50%; display:none;">
                                            </div>
                                            <button id="cropButton" class="ms-3" style="align-items: center;">Crop
                                                Images</button>
                                        </div>
                                    </div>
                                    <div>
                                        <button type="submit" class="btn"
                                            style="color: white; background-color: #66A5AD;">
                                            Submit
                                        </button>
                                    </div>
                                    <% } else { %>
                                        <div class="col mb-3">
                                            <label>Product Name:</label>
                                            <input class="form-control" value="<%= productData.productName %>"
                                                placeholder="Enter the product name" name="productName" type="text">
                                        </div>
                                        <div class="col mb-3">
                                            <label>Price:</label>
                                            <input class="form-control" value="<%= productData.price %>"
                                                placeholder="Price of the product" name="price" type="number">
                                        </div>
                                        <div class="col mb-3">
                                            <label>Stock Quantity:</label>
                                            <input class="form-control" value="<%= productData.stockQuantity %>"
                                                placeholder="Stock quantity" name="stockQuantity" type="number">
                                        </div>
                                        <div class="col mb-3">
                                            <label>Product Code:</label>
                                            <input class="form-control" value="<%= productData.productCode %>"
                                                placeholder="Product code" name="productCode" type="text">
                                        </div>
                                        <div class="mb-3">
                                            <label>Minimum Age:</label>
                                            <input class="form-control" value="<%= productData.minimumAge %>"
                                                type="number" name="minimumAge" placeholder="Minimum age" />
                                        </div>
                                        <div class="mb-3">
                                            <label>Category:</label>
                                            <div class="input-group mb-3">
                                                <select class="form-select" id="category" name="category">
                                                    <option selected>
                                                        <%= productData.category %>
                                                    </option>
                                                    <% for(let j=0; j < categories.length;j++) { %>
                                                        <option value="<%= categories[j] %>">
                                                            <%= categories[j] %>
                                                        </option>
                                                        <% } %>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label>Brand:</label>
                                            <div class="input-group mb-3">
                                                <select class="form-select" id="brand" required name="brand">
                                                    <option selected>
                                                        <%= productData.brand %>
                                                    </option>
                                                    <% for(let k=0; k < brands.length; k++) { %>
                                                        <option value="<%= brands[k] %>">
                                                            <%= brands[k] %>
                                                        </option>
                                                        <% } %>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col mb-3">
                                            <label>Description:</label>
                                            <textarea class="form-control" name="productDescription" required
                                                type="text"><%= productData.productDescription %> </textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label>Images:</label>
                                            <!-- <div class="mb-2" id="img-preview">
                                                <% for ( let x=0; x < productImage?.length; x++ ) { %>
                                                    <img src="/images/<%= productImage[x]?.filename %>"
                                                        style="width: 70px; height: 70px;" alt="">
                                                    <% } %>
                                            </div> -->

                                            <div class="mb-2" id="img-preview"
                                                style="display:flex; gap:10px; flex-wrap:wrap;">
                                                <% if (productImage) { %>
                                                    <% for (let x=0; x < productImage.length; x++) { %>
                                                        <div class="preview-box"
                                                            style="position:relative; display:inline-block; width:70px; height:70px;">

                                                            <span class="remove-btn" data-index="<%= x %>" style="position:absolute; top:-8px; right:-8px; 
                             background:red; color:white; width:20px; height:20px; 
                             border-radius:50%; display:flex; justify-content:center; 
                             align-items:center; font-size:14px; cursor:pointer;">
                                                                Ã—
                                                            </span>

                                                            <img class="previewImage"
                                                                src="/images/<%= productImage[x].filename %>"
                                                                style="width:70px; height:70px; object-fit:cover;">
                                                        </div>
                                                        <% } %>
                                                            <% } %>
                                            </div>

                                            <input type="hidden" name="deletedImages" id="deletedImages">

                                            <input class="form-control mb-1" type="file" accept="image/*"
                                                name="productImages" id="imageInput" multiple required />
                                            <div style="display: flex;">
                                                <div id="crop-container" style="width: 50%; height: 50%; display:none;">
                                                </div>
                                                <button id="cropButton" class="ms-3" style="align-items: center;">Crop
                                                    Images</button>
                                            </div>
                                        </div>
                                        <div>
                                            <button type="Edit" class="btn"
                                                style="color: white; background-color: #66A5AD;">
                                                Update
                                            </button>
                                        </div>
                                        <% } %>
            </form>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        let cropperInstances = [];

        // Handle file selection for multiple images
        document.getElementById('imageInput').addEventListener('change', function (event) {
            const files = event.target.files;
            const cropContainer = document.getElementById('crop-container');

            cropContainer.style = "display:block";
            document.getElementById('cropButton').style = 'display:block;'

            cropContainer.innerHTML = ''; // Clear any previous images
            cropperInstances = []; // Clear previous cropper instances

            // Loop through each file and create a Cropper instance
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                const imageElement = document.createElement('img');
                const imageWrapper = document.createElement('div');
                imageWrapper.style.marginBottom = '20px';

                reader.onload = function (e) {
                    imageElement.src = e.target.result;
                    imageWrapper.appendChild(imageElement);
                    cropContainer.appendChild(imageWrapper);

                    // Initialize Cropper.js for each image
                    const cropper = new Cropper(imageElement, {
                        aspectRatio: 1 / 1,
                        viewMode: 1,
                    });

                    cropperInstances.push({ cropper, originalIndex: cropperInstances.length }); // Store each cropper instance
                };

                reader.readAsDataURL(file);
            });
        });
        document.getElementById('cropButton').addEventListener('click', function (event) {
            event.preventDefault();

            const imagePreviewContainer = document.getElementById('img-preview');
            imagePreviewContainer.innerHTML = '';

            const dataTransfer = new DataTransfer();

            cropperInstances.forEach((item, index) => {
                const c = item.cropper; // the actual Cropper instance
                if (!c || typeof c.getCroppedCanvas !== 'function') return;

                c.getCroppedCanvas().toBlob((blob) => {
                    const file = new File([blob], `cropped_${index}.jpg`, { type: 'image/jpeg' });
                    dataTransfer.items.add(file);

                    const previewBox = document.createElement('div');
                    previewBox.style = `
                        position: relative;
                        display: inline-block;
                        margin-right: 10px;
                        width: 70px;
                        height: 70px;
                        `;

                    const previewImage = document.createElement('img');
                    previewImage.src = URL.createObjectURL(blob);
                    previewImage.style = 'width:70px; height:70px; object-fit:cover;';

                    const crossBtn = document.createElement('span');
                    crossBtn.innerHTML = "&times;";
                    crossBtn.style = `
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        background: red;
                        color: white;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        cursor: pointer;
                        font-size: 14px;
                        `;

                    crossBtn.addEventListener("click", () => {
                        const container = document.getElementById('img-preview');
                        const boxes = Array.from(container.children);
                        const currentIndex = boxes.indexOf(previewBox);

                        // Remove preview from UI
                        previewBox.remove();

                        // Remove cropper UI image
                        const cropContainer = document.getElementById('crop-container');
                        const cropWrappers = Array.from(cropContainer.children);
                        cropWrappers[currentIndex]?.remove();

                        // Remove cropper instance
                        cropperInstances.splice(currentIndex, 1);

                        // Remove file from DataTransfer
                        const remaining = Array.from(dataTransfer.files);
                        remaining.splice(currentIndex, 1);

                        // Rebuild DataTransfer
                        const newDT = new DataTransfer();
                        remaining.forEach(f => newDT.items.add(f));
                        document.getElementById('imageInput').files = newDT.files;
                    });


                    previewBox.appendChild(previewImage);
                    previewBox.appendChild(crossBtn);
                    imagePreviewContainer.appendChild(previewBox);

                    if (index === cropperInstances.length - 1) {
                        document.getElementById('imageInput').files = dataTransfer.files;
                    }
                });
            });

        });


        let removeButtons = document.querySelectorAll(".remove-btn");

        removeButtons.forEach((removeButton) => {
            removeButton.addEventListener('click', (e) => {
                e.preventDefault();

                let buttons = Array.from(document.querySelectorAll(".remove-btn"));
                let boxes = Array.from(document.querySelectorAll(".preview-box"));
                let images = Array.from(document.querySelectorAll(".previewImage"));

                let currentIndex = buttons.indexOf(removeButton);

                let fileName = images[currentIndex].getAttribute("src");

                fetch("/admin/deleteImage", {
                    method: "DELETE",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileName })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            boxes[currentIndex].remove();

                            toastr.info('Image deleted successfully!');
                        } else {
                            console.log(data.message);
                            toastr.warning(data.message);
                        }
                    });
            });
        });

    </script>

    <%- include ('../partials/admin-footer.ejs') %>